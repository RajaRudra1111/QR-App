<script>
  const html5QrCode = new Html5Qrcode("reader");
  const config = { fps: 10, qrbox: 250 };

  const scanBtn = document.getElementById("scanBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const readerDiv = document.getElementById("reader");
  const messageDiv = document.getElementById("message");

  const scriptApiUrl = "https://script.google.com/macros/s/AKfycbx2JyUDe0SBUsI_06uCBNqvHgUJgahpg3_R3TaCYB1ZiJsfPWpJGi6ZPqlhbLnzD9c/exec"; // Replace with your deployed Apps Script Web App URL

  scanBtn.addEventListener("click", () => {
    readerDiv.style.display = "block";
    cancelBtn.style.display = "inline-block";
    messageDiv.innerHTML = "";

    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
      .catch(err => {
        messageDiv.innerText = "Camera error: " + err;
      });
  });

  cancelBtn.addEventListener("click", () => {
    html5QrCode.stop()
      .then(() => {
        readerDiv.style.display = "none";
        cancelBtn.style.display = "none";
        messageDiv.innerText = "";
      })
      .catch(err => {
        messageDiv.innerText = "Error stopping scanner: " + err;
      });
  });

  function onScanSuccess(decodedText) {
    if (!decodedText.includes("https://docs.google.com/forms")) {
      messageDiv.innerText = "Invalid QR Code.";
      return;
    }

    html5QrCode.stop();

    const formUrl = new URL(decodedText);
    const uniqueId = formUrl.searchParams.get("entry.1887434640"); // Replace with your actual UID param

    if (!uniqueId) {
      messageDiv.innerText = "Unique ID missing in QR.";
      return;
    }

    messageDiv.innerText = "Checking QR status...";

    fetch(`${scriptApiUrl}?uid=${encodeURIComponent(uniqueId)}`)
      .then(res => res.json())
      .then(data => {
        if (data.exists) {
          // Already exists, show message and Edit button
          messageDiv.innerHTML = `
            <div style="color:red; margin-top: 10px;">QR Already Scanned!</div>
            <button class="btn" onclick="window.location.href='${formUrl.toString()}';">Edit Family Members</button>
          `;
        } else {
          // Not yet scanned â€” redirect
          messageDiv.innerText = "Redirecting to form...";
          const appBaseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1) + 'index.html';
          formUrl.searchParams.append("app_final_return_url", encodeURIComponent(appBaseUrl));
          window.location.href = formUrl.toString();
        }
      })
      .catch(err => {
        messageDiv.innerText = "Validation error: " + err.message;
      });
  }
</script>
